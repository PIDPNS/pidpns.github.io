<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Digital Event Backdrop</title>
  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Orbitron:wght@500&display=swap" rel="stylesheet">
  <!-- Authentication protection -->
  <style>
    /* Hide content completely until authentication is verified */
    body {
      visibility: hidden;
    }
    
    /* Show only the loading overlay initially */
    #auth-loading-initial {
      visibility: visible !important;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #000000 0%, #1C1C1E 50%, #2C2C2E 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 99999;
      color: white;
      font-family: 'Inter', sans-serif;
    }
  </style>
  <script>
    // Immediate page protection - runs before any content is rendered
    (function() {
      // Create loading overlay immediately
      const loadingOverlay = document.createElement('div');
      loadingOverlay.id = 'auth-loading-initial';
      loadingOverlay.innerHTML = `
        <div style="text-align: center;">
          <div style="width: 48px; height: 48px; border: 4px solid rgba(255,255,255,0.2); border-top: 4px solid #34C759; border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem;"></div>
          <div style="font-size: 1.1rem; font-weight: 500; margin-bottom: 0.5rem;">PIDPNS Digital Backdrop</div>
          <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Verifying access permissions...</div>
        </div>
        <style>
          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
        </style>
      `;
      
      // Add to head so it shows immediately
      document.head.appendChild(loadingOverlay);
      
      // Store removal function
      window.removeAuthProtection = function() {
        // Show the main content
        document.body.style.visibility = 'visible';
        
        // Smooth transition out
        if (loadingOverlay && loadingOverlay.parentNode) {
          loadingOverlay.style.opacity = '0';
          loadingOverlay.style.transition = 'opacity 0.3s ease-out';
          setTimeout(() => {
            if (loadingOverlay.parentNode) {
              loadingOverlay.parentNode.removeChild(loadingOverlay);
            }
          }, 300);
        }
      };
      
      // Failsafe: If auth takes too long, show content anyway after 10 seconds
      setTimeout(() => {
        if (document.body.style.visibility === 'hidden') {
          console.warn('Authentication took too long, showing content anyway');
          window.removeAuthProtection();
        }
      }, 10000);
    })();
  </script>
</head>
<body>
  <div class="backdrop">
    <canvas id="circuitLines"></canvas>
    <header class="header">
      <div class="logo-container">
        <img src="assets/1.png" alt="First Logo" class="logo-img" />
        <span class="logo-separator">|</span>
        <img src="assets/2.png" alt="Second Logo" class="logo-img" />
        <span class="logo-text">PERPUSTAKAAN NEGERI SABAH</span>
      </div>
      <div class="header-right">
        <div class="current-datetime" id="currentDatetime">
          <div class="time-section">
            <svg class="time-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12,6 12,12 16,14"/>
            </svg>
            <span id="currentTime"></span>
          </div>
          <span class="datetime-separator">|</span>
          <div class="date-section">
            <svg class="date-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
              <line x1="16" y1="2" x2="16" y2="6"/>
              <line x1="8" y1="2" x2="8" y2="6"/>
              <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
            <span id="currentDate"></span>
          </div>
        </div>
        <button id="themeToggle" class="theme-toggle" aria-label="Toggle light/dark mode">
          <span class="theme-icon">
            <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
            <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3A7 7 0 0 0 21 12.79z"/></svg>
          </span>
        </button>
        <!-- User Menu -->
        <div class="user-menu-container">
          <button class="user-menu-trigger" id="userMenuTrigger" aria-label="User menu">
            <img class="user-avatar" id="userAvatar" src="" alt="User Avatar" style="display: none;">
            <div class="user-initials" id="userInitials">?</div>
            <svg class="user-menu-arrow" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6,9 12,15 18,9"/>
            </svg>
          </button>
          <div class="user-menu-dropdown" id="userMenuDropdown">
            <div class="user-menu-header">
              <div class="user-display-name" id="userDisplayName">Loading...</div>
              <div class="user-email" id="userEmailDisplay">Loading...</div>
            </div>
            <div class="user-menu-divider"></div>
            <div class="user-menu-items">
              <button class="user-menu-item" onclick="window.open('sql-editor.html', '_blank')">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                  <path d="M9 9h6M9 15h6"/>
                </svg>
                SQL Editor
              </button>
              <button class="user-menu-item sign-out-btn" data-action="sign-out">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                  <polyline points="16,17 21,12 16,7"/>
                  <line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
                Sign Out
              </button>
            </div>
          </div>
        </div>
      </div>
    </header>
    <main class="main-content">
      <section class="event-info" data-screen="main">
        <div class="event-slider">
          <!-- Main Event Screen -->
          <div class="event-slide active" data-screen="main">
            <h1 class="event-title">Digital Transformation Summit 2025</h1>
            <div class="event-details">
              <span class="event-date">August 15, 2025</span>
              <span class="separator">|</span>
              <span class="event-location">Grand Convention Center</span>
            </div>
            <div class="event-hashtag">#DigiSummit2025</div>
          </div>
          <div class="event-slide" data-screen="main">
            <h1 class="event-title">Keynote Speaker</h1>
            <div class="event-details">
              <span class="event-speaker">Dr. Aisyah Rahman</span>
              <span class="separator">|</span>
              <span class="event-role">Chief Digital Officer</span>
            </div>
            <div class="event-hashtag">#InovasiDigital</div>
          </div>
          <div class="event-slide" data-screen="main">
            <h1 class="event-title">Don't Miss Out!</h1>
            <div class="event-details">
              <span class="event-highlight">Workshops, Networking, and More</span>
            </div>
            <div class="event-hashtag">#FutureReady</div>
          </div>
        </div>
      </section>

      <!-- Digital Photobooth Screen -->
      <div class="screen-container" data-screen="messages">
        <div class="messages-container">
          <h1 class="event-title" id="liveMessagesTitle">Digital Photobooth</h1>
          <div class="messages-status" id="messagesStatus">
            <div class="status-indicator improved-instructions">
              <span class="status-text">
                <span class="main-instruction">
                  Step on stage and see yourself as an award recipient. Your name, photo, and message will appear on the digital backdrop.
                </span>
                <span class="instruction-note">
                  Tip: Submit your photo and message in the Send a Message section.
                </span>
              </span>
            </div>
          </div>
          <div id="messagesPopups"></div>
        </div>
      </div>

      <!-- Send Message Screen -->
      <div class="screen-container" data-screen="send-message">
        <div class="award-message-container">
          <div class="award-header">
            <div class="award-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="8" r="6"/>
                <path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"/>
              </svg>
            </div>
            <h1 class="award-title">Digital Award Recognition</h1>
            <p class="award-subtitle">Share your achievement message and photo</p>
          </div>
          
          <form class="award-form" id="messageForm">
            <div class="form-section">
              <div class="photo-upload-area" id="photoUploadArea">
                <div class="upload-placeholder">
                  <svg class="upload-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7,10 12,15 17,10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                  </svg>
                  <span class="upload-text">Upload Your Photo</span>
                </div>
                <input type="file" id="photoInput" class="photo-input" accept="image/*" required />
                <div id="photoPreviewContainer" class="photo-preview-container">
                  <img id="photoPreview" class="photo-preview" src="" alt="Photo Preview" />
                </div>
              </div>
            </div>

            <div class="form-section">
              <div class="input-group">
                <label for="userSelect" class="input-label">Recipient Name</label>
                <div class="select-wrapper">
                  <select id="userSelect" class="award-select" required>
                    <option value="">Select your name...</option>
                    <option value="Dr. Aisyah Rahman">Dr. Aisyah Rahman</option>
                    <option value="Ahmad Zulkarnain">Ahmad Zulkarnain</option>
                    <option value="Sarah Lim">Sarah Lim</option>
                    <option value="Mohammed Ali">Mohammed Ali</option>
                    <option value="Lisa Chen">Lisa Chen</option>
                    <option value="Rajesh Kumar">Rajesh Kumar</option>
                    <option value="Emma Wilson">Emma Wilson</option>
                    <option value="David Tan">David Tan</option>
                  </select>
                  <svg class="select-arrow" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="6,9 12,15 18,9"/>
                  </svg>
                </div>
              </div>
            </div>

            <div class="form-section">
              <div class="input-group">
                <label for="messageInput" class="input-label">Award Message</label>
                <div class="textarea-wrapper">
                  <textarea id="messageInput" class="award-textarea" placeholder="Share your achievement message..." maxlength="200" required rows="3"></textarea>
                  <div class="char-counter">
                    <span id="charCount">0</span>/200
                  </div>
                </div>
              </div>
            </div>

            <button type="submit" class="award-submit">
              <svg class="submit-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"/>
                <polygon points="22,2 15,22 11,13 2,9 22,2"/>
              </svg>
              <span>Send Award Message</span>
            </button>
          </form>
        </div>
      </div>
    </main>
    <footer class="footer">
      <nav class="nav-bar">
        <div class="nav-container">
          <button class="nav-item" data-screen="official" title="Official Digital Backdrop">
            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="18" height="18" rx="3"/>
              <path d="M8 3v18M16 3v18"/>
            </svg>
          </button>
          <button class="nav-item active" data-screen="main" title="Main Event">
            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
              <polyline points="9,22 9,12 15,12 15,22"/>
            </svg>
          </button>
          <button class="nav-item" data-screen="messages" title="Digital Photobooth">
            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
              <circle cx="12" cy="13" r="4"/>
            </svg>
          </button>
          <button class="nav-item" data-screen="send-message" title="Send Message">
            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="22" y1="2" x2="11" y2="13"/>
              <polygon points="22,2 15,22 11,13 2,9 22,2"/>
            </svg>
          </button>
        </div>
      </nav>
      <div class="footer-content">
        <span>Digital Backdrop | Pasukan Inovasi Digital</span>
      </div>
    </footer>
    <!-- Move official-backdrop-page here, as a sibling to header, main-content, and footer -->
    <div class="official-backdrop-page" data-screen="official" style="display:none;">
      <div class="official-content">
        <div class="official-logo">
          <img src="assets/2.png" alt="Event Logo" class="event-logo">
        </div>
        <div class="official-details">
          <h1 class="official-title">MAJLIS PERASMIAN</h1>
          <h2 class="official-event">MINGGU PERPUSTAKAAN DAN STORYWALK® <span class="official-event-sub">(Walk With The Library)</span></h2>
          <div class="official-officiated">
            <p>Dirasmikan oleh,</p>
            <p class="official-vip">YB. Datuk Dr. Haji Mohd Arifin Bin Datuk Haji Mohd. Arif, JP</p>
            <p class="official-position">Menteri Sains, Teknologi dan Inovasi Sabah</p>
          </div>
          <div class="official-meta">
            <div class="meta-item">
              <span class="meta-text datetime-combined">24 Jun 2023 (Sabtu) | 🕗 08:00 Pagi</span>
            </div>
            <div class="meta-item">
              <span class="meta-text">Taman Ujana Rimba Tropika & Dewan Mataking,<br>Ibu Pejabat Perpustakaan Negeri Sabah</span>
            </div>
          </div>
          <div class="official-slogan">"SABAH MAJU JAYA"</div>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="auth.js"></script>
  <script src="official-editor.js"></script>
  <script src="script.js"></script>
  <script>
    // Initialize authentication before anything else
    document.addEventListener('DOMContentLoaded', async function() {
      // Initialize Supabase client
      const SUPABASE_URL = 'https://amxvmnzhwehxmnwzzaoy.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFteHZtbnpod2VoeG1ud3p6YW95Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5NTc5NDksImV4cCI6MjA2NzUzMzk0OX0.Vedmvf0QnCEh5TdgarY48BW2vrBgmYayQ2c-fcKFHlo';
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      
      try {
        // Initialize authentication
        const isAuthenticated = await initializeAuth(supabase);
        
        if (isAuthenticated) {
          // Remove protection overlay with smooth transition
          if (window.removeAuthProtection) {
            window.removeAuthProtection();
          }
          
          // Initialize user menu
          setupUserMenu();
          
          // Initialize official page editor
          if (typeof initializeOfficialEditor === 'function') {
            initializeOfficialEditor(supabase);
          }
          
          console.log('Digital Backdrop initialized with authentication');
        } else {
          // Not authenticated - redirect to login with smooth transition
          // Update loading message
          const loadingDiv = document.querySelector('#auth-loading-initial div');
          if (loadingDiv) {
            loadingDiv.innerHTML = `
              <div style="width: 48px; height: 48px; border: 4px solid rgba(255,255,255,0.2); border-top: 4px solid #34C759; border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem;"></div>
              <div style="font-size: 1.1rem; font-weight: 500; margin-bottom: 0.5rem;">Access Required</div>
              <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Redirecting to login...</div>
            `;
          }
          
          // Smooth redirect after a short delay
          setTimeout(() => {
            window.location.href = 'login.html';
          }, 800);
        }
      } catch (error) {
        console.error('Failed to initialize authentication:', error);
        
        // Update loading message for error
        const loadingDiv = document.querySelector('#auth-loading-initial div');
        if (loadingDiv) {
          loadingDiv.innerHTML = `
            <div style="width: 48px; height: 48px; border: 4px solid rgba(255,59,48,0.3); border-top: 4px solid #FF3B30; border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem;"></div>
            <div style="font-size: 1.1rem; font-weight: 500; margin-bottom: 0.5rem;">Authentication Error</div>
            <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Redirecting to login...</div>
          `;
        }
        
        // Redirect to login on any auth error
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 1500);
      }
    });

    // Set up user menu functionality
    function setupUserMenu() {
      const userMenuTrigger = document.getElementById('userMenuTrigger');
      const userMenuDropdown = document.getElementById('userMenuDropdown');
      const userAvatar = document.getElementById('userAvatar');
      const userInitials = document.getElementById('userInitials');
      const userDisplayName = document.getElementById('userDisplayName');
      const userEmailDisplay = document.getElementById('userEmailDisplay');

      if (!authManager) return;

      // Update user info
      const displayName = authManager.getUserDisplayName();
      const email = authManager.getUserEmail();
      const avatarUrl = authManager.getUserAvatar();

      userDisplayName.textContent = displayName;
      userEmailDisplay.textContent = email;

      // Set avatar or initials
      if (avatarUrl) {
        userAvatar.src = avatarUrl;
        userAvatar.style.display = 'block';
        userInitials.style.display = 'none';
      } else {
        userAvatar.style.display = 'none';
        userInitials.style.display = 'flex';
        // Get initials from display name
        const initials = displayName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        userInitials.textContent = initials;
      }

      // Toggle dropdown
      let isMenuOpen = false;
      userMenuTrigger.addEventListener('click', (e) => {
        e.stopPropagation();
        isMenuOpen = !isMenuOpen;
        userMenuDropdown.classList.toggle('show', isMenuOpen);
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', () => {
        if (isMenuOpen) {
          isMenuOpen = false;
          userMenuDropdown.classList.remove('show');
        }
      });

      // Prevent dropdown from closing when clicking inside
      userMenuDropdown.addEventListener('click', (e) => {
        e.stopPropagation();
      });
    }
  </script>
</body>
</html>
